{% extends 'tracker/base.html' %}
{% load static %}

{% block title %}Register Customer{% endblock %}

{% block content %}
  <div class="container-fluid">
    <div class="page-title">
      <div class="row">
        <div class="col-6"><h4>Customer Registration</h4></div>
        <div class="col-6">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'tracker:customers_list' %}">Customers</a></li>
            <li class="breadcrumb-item active">Register</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-xl-10">
        <div class="card">
          <div class="card-header"><h5 class="mb-0">Step {{ step }} of 4</h5></div>
          <div class="card-body">
            {% if messages %}
              {% for m in messages %}
                <div class="alert alert-{{ m.tags }}">{{ m }}</div>
              {% endfor %}
            {% endif %}

            <div class="horizontal-wizard-wrapper">
              <div class="row g-3">
                <div class="col-12 main-horizontal-header">
                  <div class="nav nav-pills horizontal-options" role="tablist" aria-orientation="vertical">
                    <a class="nav-link {% if step == 1 %}active{% endif %}" href="{% url 'tracker:customer_register' %}?step=1">
                      <div class="horizontal-wizard"><div class="stroke-icon-wizard"><i class="fa fa-user"></i></div><div class="horizontal-wizard-content"><h6>Basic Info</h6></div></div>
                    </a>
                    <a class="nav-link {% if step == 2 %}active{% endif %}" href="{% url 'tracker:customer_register' %}?step=2">
                      <div class="horizontal-wizard"><div class="stroke-icon-wizard"><i class="fa fa-list"></i></div><div class="horizontal-wizard-content"><h6>Service Intent</h6></div></div>
                    </a>
                    <a class="nav-link {% if step == 3 %}active{% endif %}" href="{% url 'tracker:customer_register' %}?step=3">
                      <div class="horizontal-wizard"><div class="stroke-icon-wizard"><i class="fa fa-cogs"></i></div><div class="horizontal-wizard-content"><h6>Service Type</h6></div></div>
                    </a>
                    <a class="nav-link {% if step == 4 %}active{% endif %}" href="{% url 'tracker:customer_register' %}?step=4">
                      <div class="horizontal-wizard"><div class="stroke-icon-wizard"><i class="fa fa-check"></i></div><div class="horizontal-wizard-content"><h6>Details & Review</h6></div></div>
                    </a>
                  </div>
                </div>
                <div class="col-12">
                  <form method="post" novalidate id="customer-register-form">
                    {% csrf_token %}
                    <input type="hidden" name="step" value="{{ step }}">

                    {% if step == 1 %}
                      <div class="mb-3"><label class="form-label f-w-600">Basic Customer Information</label></div>
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label" for="id_full_name">Full Name <span class="text-danger">*</span></label>
                          {{ form.full_name }}
                          {% if form.full_name.errors %}<div class="text-danger f-12">{{ form.full_name.errors|striptags }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                          <label class="form-label" for="id_phone">Phone Number <span class="text-danger">*</span></label>
                          {{ form.phone }}
                          <div class="f-light f-12">Format: +256 XXX XXX XXX</div>
                          {% if form.phone.errors %}<div class="text-danger f-12">{{ form.phone.errors|striptags }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                          <label class="form-label" for="id_email">Email Address</label>
                          {{ form.email }}
                          {% if form.email.errors %}<div class="text-danger f-12">{{ form.email.errors|striptags }}</div>{% endif %}
                        </div>
                        <div class="col-12">
                          <label class="form-label" for="id_address">Address</label>
                          {{ form.address }}
                          {% if form.address.errors %}<div class="text-danger f-12">{{ form.address.errors|striptags }}</div>{% endif %}
                        </div>
                        <div class="col-12">
                          <label class="form-label" for="id_notes">Notes</label>
                          {{ form.notes }}
                          {% if form.notes.errors %}<div class="text-danger f-12">{{ form.notes.errors|striptags }}</div>{% endif %}
                        </div>
                      </div>
                      <div class="d-flex gap-2 mt-4">
                        <button class="btn btn-primary" type="submit">Next</button>
                        <button class="btn btn-outline-secondary" type="submit" name="action" value="save_customer">Save Customer Only</button>
                      </div>

                    {% elif step == 2 %}
                      <div class="mb-3"><label class="form-label f-w-600">Service Intent Selection</label></div>
                      <div class="row g-3">
                        <div class="col-12">
                          <div class="list-group">
                            <label class="list-group-item d-flex align-items-center gap-2">
                              <span class="form-check">
                                <input class="form-check-input" type="radio" name="intent" value="service" {% if form.intent.value == 'service' %}checked{% endif %}>
                              </span>
                              <span class="f-w-600">I need a service</span>
                            </label>
                            <label class="list-group-item d-flex align-items-center gap-2">
                              <span class="form-check">
                                <input class="form-check-input" type="radio" name="intent" value="sales" {% if form.intent.value == 'sales' %}checked{% endif %}>
                              </span>
                              <span class="f-w-600">Tire sales / parts</span>
                            </label>
                            <label class="list-group-item d-flex align-items-center gap-2">
                              <span class="form-check">
                                <input class="form-check-input" type="radio" name="intent" value="inquiry" {% if form.intent.value == 'inquiry' %}checked{% endif %}>
                              </span>
                              <span class="f-w-600">Just an inquiry</span>
                            </label>
                          </div>
                          {% if form.intent.errors %}<div class="text-danger f-12 mt-2">{{ form.intent.errors|striptags }}</div>{% endif %}
                        </div>
                      </div>
                      <div class="d-flex gap-2 mt-4">
                        <a class="btn btn-light" href="{% url 'tracker:customer_register' %}?step=1">Back</a>
                        <button class="btn btn-primary" type="submit">Next</button>
                      </div>

                    {% elif step == 3 %}
                      <div class="mb-3"><label class="form-label f-w-600">Service Type Selection</label></div>
                      <div class="row g-3">
                        {% if intent == 'service' %}
                          <div class="col-12">
                            <div class="mb-2 f-w-600">Select car service(s)</div>
                            {{ form.service_type }}
                            {% if form.service_type.errors %}<div class="text-danger f-12">{{ form.service_type.errors|striptags }}</div>{% endif %}
                          </div>
                        {% elif intent == 'sales' %}
                          <div class="col-12">
                            <div class="mb-2 f-w-600">Select sales category</div>
                            {{ form.sales_type }}
                            {% if form.sales_type.errors %}<div class="text-danger f-12">{{ form.sales_type.errors|striptags }}</div>{% endif %}
                          </div>
                        {% else %}
                          <div class="col-12">
                            <div class="alert alert-info">No service type selection required for inquiries.</div>
                          </div>
                        {% endif %}
                      </div>
                      <div class="d-flex gap-2 mt-4">
                        <a class="btn btn-light" href="{% url 'tracker:customer_register' %}?step=2">Back</a>
                        <button class="btn btn-primary" type="submit">Next</button>
                      </div>

                    {% else %}
                      <div class="mb-3"><label class="form-label f-w-600">Customer Type & Order Details</label></div>
                      <div class="row g-4">
                        <div class="col-md-6">
                          <h6 class="mb-2">Customer Type Classification</h6>
                          <div class="mb-3">
                            <label class="form-label" for="id_customer_type">Customer Type <span class="text-danger">*</span></label>
                            {{ form.customer_type }}
                            {% if form.customer_type.errors %}<div class="text-danger f-12">{{ form.customer_type.errors|striptags }}</div>{% endif %}
                          </div>
                          <div class="mb-3 org-fields">
                            <label class="form-label" for="id_organization_name">Organization Name</label>
                            {{ form.organization_name }}
                            {% if form.organization_name.errors %}<div class="text-danger f-12">{{ form.organization_name.errors|striptags }}</div>{% endif %}
                          </div>
                          <div class="mb-3 org-fields">
                            <label class="form-label" for="id_tax_number">Tax Number</label>
                            {{ form.tax_number }}
                            {% if form.tax_number.errors %}<div class="text-danger f-12">{{ form.tax_number.errors|striptags }}</div>{% endif %}
                          </div>
                          <div class="mb-3 personal-fields">
                            <label class="form-label" for="id_personal_subtype">Personal Sub-type</label>
                            {{ form.personal_subtype }}
                            {% if form.personal_subtype.errors %}<div class="text-danger f-12">{{ form.personal_subtype.errors|striptags }}</div>{% endif %}
                          </div>
                        </div>
                        <div class="col-md-6">
                          <h6 class="mb-2">Vehicle (optional)</h6>
                          {% if vehicle_form %}
                            {% for field in vehicle_form %}
                              <div class="mb-3">
                                <label class="form-label" for="id_{{ field.name }}">{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}<div class="text-danger f-12">{{ field.errors|striptags }}</div>{% endif %}
                              </div>
                            {% endfor %}
                          {% endif %}
                        </div>
                        <div class="col-12">
                          <h6 class="mb-2">Order Details</h6>
                          {% if order_form %}
                            <div class="row g-3">
                              <div class="col-md-6">
                                <label class="form-label" for="id_type">Order Type</label>
                                {{ order_form.type }}
                                {% if order_form.type.errors %}<div class="text-danger f-12">{{ order_form.type.errors|striptags }}</div>{% endif %}
                              </div>
                              <div class="col-md-6">
                                <label class="form-label" for="id_priority">Priority Level</label>
                                {{ order_form.priority }}
                                {% if order_form.priority.errors %}<div class="text-danger f-12">{{ order_form.priority.errors|striptags }}</div>{% endif %}
                              </div>
                              <div class="col-12">
                                <label class="form-label" for="id_vehicle">Vehicle</label>
                                {{ order_form.vehicle }}
                                {% if order_form.vehicle.errors %}<div class="text-danger f-12">{{ order_form.vehicle.errors|striptags }}</div>{% endif %}
                              </div>
                            </div>
                            {% if intent == 'service' %}
                              <div class="row g-3 mt-1">
                                <div class="col-12">
                                  <div class="mb-2 f-w-600">Service Selection</div>
                                  {{ order_form.service_selection }}
                                  {% if order_form.service_selection.errors %}<div class="text-danger f-12">{{ order_form.service_selection.errors|striptags }}</div>{% endif %}
                                </div>
                                <div class="col-md-8">
                                  <label class="form-label" for="id_description">Problem Description</label>
                                  {{ order_form.description }}
                                  {% if order_form.description.errors %}<div class="text-danger f-12">{{ order_form.description.errors|striptags }}</div>{% endif %}
                                </div>
                                <div class="col-md-4">
                                  <label class="form-label" for="id_estimated_duration">Estimated Duration (minutes)</label>
                                  {{ order_form.estimated_duration }}
                                  {% if order_form.estimated_duration.errors %}<div class="text-danger f-12">{{ order_form.estimated_duration.errors|striptags }}</div>{% endif %}
                                </div>
                              </div>
                            {% elif intent == 'sales' %}
                              <div class="row g-3 mt-1">
                                <div class="col-md-6">
                                  <label class="form-label" for="id_item_name">Item Name</label>
                                  {{ order_form.item_name }}
                                  {% if order_form.item_name.errors %}<div class="text-danger f-12">{{ order_form.item_name.errors|striptags }}</div>{% endif %}
                                </div>
                                <div class="col-md-6">
                                  <label class="form-label" for="id_brand">Brand</label>
                                  {{ order_form.brand }}
                                  {% if order_form.brand.errors %}<div class="text-danger f-12">{{ order_form.brand.errors|striptags }}</div>{% endif %}
                                </div>
                                <div class="col-md-6">
                                  <label class="form-label" for="id_quantity">Quantity</label>
                                  {{ order_form.quantity }}
                                  {% if order_form.quantity.errors %}<div class="text-danger f-12">{{ order_form.quantity.errors|striptags }}</div>{% endif %}
                                </div>
                                <div class="col-md-6">
                                  <label class="form-label" for="id_tire_type">Tire Type</label>
                                  {{ order_form.tire_type }}
                                  {% if order_form.tire_type.errors %}<div class="text-danger f-12">{{ order_form.tire_type.errors|striptags }}</div>{% endif %}
                                </div>
                              </div>
                            {% else %}
                              <div class="row g-3 mt-1">
                                <div class="col-md-6">
                                  <label class="form-label" for="id_inquiry_type">Inquiry Type</label>
                                  {{ order_form.inquiry_type }}
                                  {% if order_form.inquiry_type.errors %}<div class="text-danger f-12">{{ order_form.inquiry_type.errors|striptags }}</div>{% endif %}
                                </div>
                                <div class="col-md-6">
                                  <label class="form-label" for="id_contact_preference">Contact Preference</label>
                                  {{ order_form.contact_preference }}
                                  {% if order_form.contact_preference.errors %}<div class="text-danger f-12">{{ order_form.contact_preference.errors|striptags }}</div>{% endif %}
                                </div>
                                <div class="col-12">
                                  <label class="form-label" for="id_questions">Questions</label>
                                  {{ order_form.questions }}
                                  {% if order_form.questions.errors %}<div class="text-danger f-12">{{ order_form.questions.errors|striptags }}</div>{% endif %}
                                </div>
                                <div class="col-md-6">
                                  <label class="form-label" for="id_follow_up_date">Follow-up Date</label>
                                  {{ order_form.follow_up_date }}
                                  {% if order_form.follow_up_date.errors %}<div class="text-danger f-12">{{ order_form.follow_up_date.errors|striptags }}</div>{% endif %}
                                </div>
                              </div>
                            {% endif %}
                          {% endif %}
                        </div>
                      </div>
                      <div class="d-flex gap-2 mt-4">
                        <a class="btn btn-light" href="{% url 'tracker:customer_register' %}?step=3">Back</a>
                        <button class="btn btn-success" type="submit">Submit</button>
                      </div>

                      {% if step1 or step2 or step3 %}
                        <hr>
                        <h6 class="mb-2">Summary</h6>
                        <div class="row g-2">
                          <div class="col-md-3"><div class="f-light">Name</div><div class="f-w-600">{{ step1.full_name }}</div></div>
                          <div class="col-md-3"><div class="f-light">Phone</div><div class="f-w-600">{{ step1.phone }}</div></div>
                          <div class="col-md-3"><div class="f-light">Email</div><div class="f-w-600">{{ step1.email }}</div></div>
                          <div class="col-md-3"><div class="f-light">Intent</div><div class="f-w-600 text-capitalize">{{ step2.intent }}</div></div>
                        </div>
                      {% endif %}
                    {% endif %}
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      var form = document.getElementById('customer-register-form');
      if (!form) return;

      // LocalStorage draft persistence per step
      var key = 'customer_reg_step_' + ({{ step }} || 1);
      try {
        var saved = localStorage.getItem(key);
        if (saved) {
          var data = JSON.parse(saved);
          Object.keys(data).forEach(function(name){
            var el = form.querySelector('[name="' + name + '"]');
            if (!el) return;
            if (el.type === 'radio' || el.type === 'checkbox') {
              var list = form.querySelectorAll('[name="' + name + '"]');
              list.forEach(function(r){ r.checked = Array.isArray(data[name]) ? data[name].includes(r.value) : (r.value === data[name]); });
            } else {
              el.value = data[name];
            }
          });
        }
      } catch(e) {}

      function capture() {
        var payload = {};
        var elements = form.querySelectorAll('input, textarea, select');
        elements.forEach(function(el){
          if (!el.name) return;
          if (el.type === 'radio') {
            if (el.checked) payload[el.name] = el.value;
          } else if (el.type === 'checkbox') {
            var group = form.querySelectorAll('[name="' + el.name + '"]');
            var vals = [];
            group.forEach(function(c){ if (c.checked) vals.push(c.value); });
            payload[el.name] = vals;
          } else {
            payload[el.name] = el.value;
          }
        });
        try { localStorage.setItem(key, JSON.stringify(payload)); } catch(e) {}
      }

      form.addEventListener('change', capture);
      form.addEventListener('input', capture);

      // Toggle org/personal fields on step 4
      function toggleCustomerFields() {
        var typeSel = document.getElementById('id_customer_type');
        if (!typeSel) return;
        var val = typeSel.value;
        var showOrg = ['government','ngo','company'].indexOf(val) !== -1;
        var showPersonal = val === 'personal';
        document.querySelectorAll('.org-fields').forEach(function(el){ el.style.display = showOrg ? '' : 'none'; });
        document.querySelectorAll('.personal-fields').forEach(function(el){ el.style.display = showPersonal ? '' : 'none'; });
      }
      var typeSel = document.getElementById('id_customer_type');
      if (typeSel) {
        typeSel.addEventListener('change', toggleCustomerFields);
        toggleCustomerFields();
      }
    })();
  </script>

  <script src="{% static 'assets/js/form-wizard/form-wizard.js' %}"></script>
{% endblock %}
