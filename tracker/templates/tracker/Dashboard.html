{% extends 'tracker/base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
  <div class="container-fluid">
    <div class="page-title">
      <div class="row">
        <div class="col-6"><h4>Dashboard</h4></div>
        <div class="col-6">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}">
              <svg class="stroke-icon"><use href="../assets/svg/icon-sprite.svg#stroke-home"></use></svg></a>
            </li>
            <li class="breadcrumb-item">Overview</li>
            <li class="breadcrumb-item active">Live</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row g-3 mb-3">
      <div class="col-sm-6 col-xl-2"><div class="card"><div class="card-body text-center"><div class="f-light f-12">Total Orders</div><div class="f-w-600 f-20">{{ total_orders }}</div></div></div></div>
      <div class="col-sm-6 col-xl-2"><div class="card"><div class="card-body text-center"><div class="f-light f-12">Active</div><div class="f-w-600 f-20">{{ active_count }}</div></div></div></div>
      <div class="col-sm-6 col-xl-2"><div class="card"><div class="card-body text-center"><div class="f-light f-12">In Progress</div><div class="f-w-600 f-20">{{ in_progress_count }}</div></div></div></div>
      <div class="col-sm-6 col-xl-2"><div class="card"><div class="card-body text-center"><div class="f-light f-12">Completed Today</div><div class="f-w-600 f-20">{{ completed_today_count }}</div></div></div></div>
      <div class="col-sm-6 col-xl-2"><div class="card"><div class="card-body text-center"><div class="f-light f-12">Customers</div><div class="f-w-600 f-20">{{ total_customers }}</div></div></div></div>
      <div class="col-sm-6 col-xl-2"><div class="card"><div class="card-body text-center"><div class="f-light f-12">Total Stock</div><div class="f-w-600 f-20">{{ total_stock }}</div></div></div></div>
    </div>

    <div class="row">
      <div class="col-xl-6 box-col-7">
        <div class="card">
          <div class="card-header sales-chart card-no-border pb-0">
            <h4>Orders Trend</h4>
            <div class="sales-chart-dropdown">
              <ul class="balance-data">
                <li><span class="circle bg-primary"></span><span class="f-light ms-1">Orders</span></li>
              </ul>
            </div>
          </div>
          <div class="card-body p-2 pt-0">
            <div class="sales-wrapper"><div id="saleschart"></div></div>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6">
        <div class="card">
          <div class="card-header card-no-border total-revenue pb-0"><h4>Status Breakdown</h4></div>
          <div class="card-body pt-0">
            <ul class="product-costing">
              <li class="product-cost"><div class="product-icon bg-primary-light"></div><div><span class="f-w-500 f-14 mb-0">Created</span><h2 class="f-w-600">{{ status_counts.created|default:0 }}</h2></div></li>
            </ul>
            <ul class="product-costing">
              <li class="product-cost"><div class="product-icon bg-warning-light"></div><div><span class="f-w-500 f-14 mb-0">Assigned</span><h2 class="f-w-600">{{ status_counts.assigned|default:0 }}</h2></div></li>
            </ul>
            <ul class="product-costing">
              <li class="product-cost"><div class="product-icon bg-light"></div><div><span class="f-w-500 f-14 mb-0">In Progress</span><h2 class="f-w-600">{{ status_counts.in_progress|default:0 }}</h2></div></li>
            </ul>
            <ul class="product-costing">
              <li class="product-cost"><div class="product-icon bg-secondary-light"></div><div><span class="f-w-500 f-14 mb-0">Completed</span><h2 class="f-w-600">{{ status_counts.completed|default:0 }}</h2></div></li>
            </ul>
            <ul class="product-costing">
              <li class="product-cost"><div class="product-icon bg-danger-light"></div><div><span class="f-w-500 f-14 mb-0">Cancelled</span><h2 class="f-w-600">{{ status_counts.cancelled|default:0 }}</h2></div></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-xl-3 col-md-6">
        <div class="card">
          <div class="card-header total-revenue card-no-border pb-0"><h4>Notifications</h4></div>
          <div class="card-body pt-0">
            {% if low_stock_items %}
              <div class="mb-2 f-w-600">Low Stock</div>
              <ul class="list-unstyled">
                {% for it in low_stock_items %}
                  <li class="d-flex justify-content-between align-items-center mb-1">
                    <span class="f-14 line-clamp">{{ it.name }}{% if it.brand %} ({{ it.brand }}){% endif %}</span>
                    <span class="badge rounded-pill badge-danger">{{ it.quantity }}</span>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="f-light f-12">No low stock items</div>
            {% endif %}
            <hr>
            {% if long_in_progress %}
              <div class="mb-2 f-w-600">Overdue In-Progress</div>
              <ul class="list-unstyled mb-0">
                {% for o in long_in_progress %}
                  <li class="mb-1">
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="f-14 line-clamp">{{ o.order_number }} â€” {{ o.customer }}</span>
                      <span class="badge rounded-pill badge-warning">{{ o.elapsed }}m</span>
                    </div>
                    {% if o.vehicle %}<div class="f-light f-12">{{ o.vehicle }}</div>{% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="f-light f-12">No overdue services</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-xxl-6 col-md-12 box-col-12">
        <div class="card height-equal">
          <div class="card-header total-revenue card-no-border"><h4>Latest Orders</h4></div>
          <div class="card-body pt-0">
            <div class="table-order table-responsive custom-scrollbar">
              <table class="latest-orders w-100">
                <thead>
                  <tr>
                    <th>Order</th>
                    <th>Customer</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Created</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in recent_orders %}
                    <tr>
                      <td><div class="product-sub"><a class="f-14 f-w-500" href="{% url 'tracker:order_detail' r.id %}">{{ r.order_number }}</a></div></td>
                      <td><div class="product-sub"><a class="f-14 f-w-500" href="{% url 'tracker:customer_detail' r.customer.id %}">{{ r.customer.full_name }}</a></div></td>
                      <td class="text-capitalize">{{ r.type }}</td>
                      <td>
                        {% if r.status == 'completed' %}<div class="badge-light-primary product-sub badge rounded-pill"><span>Completed</span></div>
                        {% elif r.status == 'in_progress' %}<div class="badge-light-secondary product-sub badge rounded-pill"><span>In Progress</span></div>
                        {% elif r.status == 'assigned' %}<div class="badge-light-warning product-sub badge rounded-pill"><span>Assigned</span></div>
                        {% elif r.status == 'cancelled' %}<div class="badge-light-light product-sub badge rounded-pill"><span>Cancelled</span></div>
                        {% else %}<div class="badge-light-info product-sub badge rounded-pill"><span>Created</span></div>{% endif %}
                      </td>
                      <td>{{ r.created_at|date:'Y-m-d H:i' }}</td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="5" class="text-center f-light">No orders</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="col-xxl-6 box-col-12">
        <div class="card">
          <div class="card-header total-revenue card-no-border"><h4>Inventory Snapshot</h4></div>
          <div class="card-body pt-0">
            <div class="table-order table-responsive custom-scrollbar">
              <table class="order-table w-100">
                <thead><tr><th>Item</th><th>Brand</th><th>Qty</th><th>Added</th></tr></thead>
                <tbody>
                  {% for it in inventory_preview %}
                    <tr>
                      <td>{{ it.name }}</td>
                      <td>{{ it.brand|default:'Unbranded' }}</td>
                      <td>{{ it.quantity }}</td>
                      <td>{{ it.created_at|date:'Y-m-d' }}</td>
                    </tr>
                  {% empty %}
                    <tr><td colspan="4" class="text-center f-light">No inventory</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="{% static 'assets/js/chart/apex-chart/apex-chart.js' %}"></script>
  <script>
    (function(){
      try {
        var charts = JSON.parse('{{ charts_json|escapejs }}');
        var labels = charts.trend.labels || [];
        var values = charts.trend.values || [];
        var options = {
          series: [{ name: 'Orders', data: values }],
          colors: [RihoAdminConfig.primary],
          chart: { height: 280, type: 'area', toolbar: { show: false } },
          dataLabels: { enabled: false },
          stroke: { curve: 'smooth', width: 2 },
          fill: { gradient:{ opacityFrom: 0.5, opacityTo: 0, shadeIntensity: 0.2 } },
          grid: { strokeDashArray: 5 },
          xaxis: { categories: labels, axisTicks:{show:false}, axisBorder:{show:false} },
          legend: { show: false }
        };
        var chart = new ApexCharts(document.querySelector('#saleschart'), options);
        chart.render();
      } catch(e) {}
      try{
        var lowCount = {{ low_stock_items|length|default:0 }};
        var longCount = {{ long_in_progress|length|default:0 }};
        var total = (lowCount + longCount) || 0;
        var badge = document.querySelector('.notification-box .badge');
        if(badge){ badge.textContent = total; }
      }catch(e){}
    })();
  </script>
{% endblock %}
